# ワークフロー名: GitHubのActionsタブに表示されます
name: 'Release Tauri App'

# ワークフローのトリガー設定
on:
  push:
    tags:
      # 'v*.*.*' 形式のタグ（例: v1.0.0, v0.2.7）がプッシュされた時のみ実行
      - 'v*.*.*'

jobs:
  # Windowsビルド＆リリース用ジョブ
  build-release-windows:
    # GitHub Releasesへの書き込み権限を付与
    permissions:
      contents: write

    # Windows Server の最新版で実行
    runs-on: windows-latest

    steps:
      # --- 1. 環境セットアップ ---

      # リポジトリのソースコードを仮想マシンにチェックアウト
      - name: Checkout repository
        uses: actions/checkout@v4

      # Node.js (最新LTS版) をセットアップ
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: lts/* # 最新のLTSバージョンを使用
          cache: 'npm'          # npmのキャッシュを有効化

      # Rust (安定版) をセットアップ
      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable

      # Rustのビルドキャッシュ（targetディレクトリ）を設定し、ビルドを高速化
      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          # src-tauri内の変更を監視し、targetディレクトリをキャッシュ
          workspaces: './src-tauri -> target'

      # --- 2. ビルドプロセス ---

      # フロントエンドの依存関係をインストール (package-lock.json に基づく)
      - name: Install frontend dependencies
        run: npm ci

      # Tauriアプリケーション本体をビルド
      - name: Build Tauri app
        # アプリのビルドと署名に必要な全ての秘密鍵を環境変数として渡す
        env:
          # --- B. アップデーター署名 (無料 / .zip, .sigファイル用) ---
          # (tauri signer generate で生成した秘密鍵)
          # これがないと .msi.zip が生成されず、以前のエラーが発生します
          TAURI_PRIVATE_KEY: ${{ secrets.TAURI_PRIVATE_KEY }}
          # 上記秘密鍵のパスワード（設定した場合のみ）
          TAURI_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_PRIVATE_KEY_PASSWORD }}

          # --- A. OS署名 (有料 / .msi, .exeファイル用) ---
          # (コード署名証明書 .pfx をBase64エンコードしたもの)
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          # 上記 .pfx ファイルのパスワード
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}

        # 'npm run tauri build' を実行してリリースビルド
        run: npm run tauri build

      # --- 3. アップデーター用JSONの生成 ---

      # PowerShellを使い、アップデーター用の 'latest.json' を動的に生成
      - name: Prepare updater assets and latest.json
        shell: pwsh # PowerShellでスクリプトを実行
        run: |
          # エラーが発生したら即座に停止
          $ErrorActionPreference = 'Stop'

          # GitHubの環境変数から情報を取得
          $tag = "${{ github.ref_name }}"           # 例: v1.2.3
          $version = $tag.TrimStart('v')          # 例: 1.2.3
          $owner,$repo = "${{ github.repository }}".Split('/') # 例: JunseiOgawa/VDI-solid

          # Tauriが生成したアップデーター用ファイルのディレクトリ
          $updaterDir = "src-tauri/target/release/bundle/updater"
          if (!(Test-Path $updaterDir)) { throw "Updater artifacts not found: $updaterDir" }

          # アップデーター用の .zip ファイルを特定（Windows用を優先）
          $zip = Get-ChildItem $updaterDir -Recurse -Filter *.zip | Where-Object { $_.Name -match 'windows|win|x64' } | Select-Object -First 1
          if (-not $zip) { $zip = Get-ChildItem $updaterDir -Recurse -Filter *.zip | Select-Object -First 1 }
          if (-not $zip) { throw "No updater .zip found under $updaterDir" }

          # 対応する署名ファイル（.sig）のパスを特定し、中身を読み取る
          $sigPath = "$($zip.FullName).sig"
          if (!(Test-Path $sigPath)) {
            $sigCandidate = Join-Path $zip.DirectoryName ($zip.BaseName + ".sig")
            if (Test-Path $sigCandidate) { $sigPath = $sigCandidate } else { throw "Signature file not found for $($zip.Name)" }
          }
          $signature = (Get-Content $sigPath -Raw).Trim() # .sigファイルの中身を取得

          # latest.json に記載するダウンロードURLを生成
          $url = "https://github.com/$owner/$repo/releases/download/$tag/$($zip.Name)"
          # 現在時刻をISO 8601形式 (UTC) で取得
          $pubDate = (Get-Date).ToUniversalTime().ToString("yyyy-MM-ddTHH:mm:ssZ")

          # latest.json の中身となるPowerShellオブジェクトを作成
          $json = @{
            version = $version
            notes = "Release $tag"
            pub_date = $pubDate
            platforms = @{
              "windows-x86_64" = @{
                url = $url
                signature = $signature
              }
            }
          } | ConvertTo-Json -Depth 5 # オブジェクトをJSON文字列に変換

          # 'latest.json' ファイルとして書き出し
          Set-Content -Path "latest.json" -Value $json -Encoding UTF8
          Write-Host "Generated latest.json:"
          Write-Host $json

      # --- 4. リリースとアップロード ---

      # 'softprops/action-gh-release' アクションを使い、リリースを作成＆成果物をアップロード
      - name: Upload Release Assets
        uses: softprops/action-gh-release@v2.0.9
        with:
          # トリガーとなったタグ名をリリースタグとして使用
          tag_name: ${{ github.ref_name }}
          # リリース名を設定
          name: Release ${{ github.ref_name }}
          # リリースの説明文
          body: |
            Automatic release for ${{ github.ref_name }}.
            See assets below for installers.
          draft: false      # 下書きとして作成しない
          prerelease: false # プレリリースとしてマークしない

          # アップロードするファイルのパターンを指定
          files: |
            src-tauri/target/release/bundle/msi/*.msi
            src-tauri/target/release/bundle/nsis/*-setup.exe
            src-tauri/target/release/bundle/updater/**/*.zip
            src-tauri/target/release/bundle/updater/**/*.sig
            latest.json
