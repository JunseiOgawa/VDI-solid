# このワークフローは、タグがプッシュされたときにWindows向けのアプリケーションをビルドし、
# GitHub Releasesページに自動的にアップロードします

name: "Release"

# トリガー設定：v*.*.*形式のタグがプッシュされた時に実行
on:
  push:
    tags:
      - "v*.*.*" # 例: v0.2.7, v1.0.0

jobs:
  build-windows:
    # GitHub Releasesにアップロードするための権限を付与
    permissions:
      contents: write

    # Windows環境でビルドを実行
    runs-on: windows-latest

    steps:
      # ステップ1: リポジトリをチェックアウト
      - name: Checkout repository
        uses: actions/checkout@v4

      # ステップ2: Node.js環境をセットアップ（フロントエンドビルド用）
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: lts/* # 最新LTS版を使用
          cache: "npm" # npm キャッシュを有効化（高速化）

      # ステップ3: Rust 安定版ツールチェーンをインストール
      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable

      # ステップ4: Rustビルドのキャッシュを設定（高速化）
      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: "./src-tauri -> target" # src-tauri/targetをキャッシュ対象に指定

      # ステップ5: フロントエンドの依存パッケージをインストール
      - name: Install frontend dependencies
        run: npm ci # npm ci を使用（本番環境向けの安定インストール）

      # ステップ6: Tauriアプリケーションをビルド
      # このステップで以下のファイルが生成されます：
      #   - MSI インストーラ（src-tauri/target/release/bundle/msi/）
      #   - NSIS インストーラ（src-tauri/target/release/bundle/nsis/）
      - name: Build Tauri app
        run: npm run tauri build # リリースビルド（最適化有効）
        env:
          # アップデータ署名に使用する秘密鍵。リポジトリのSecretsに設定してください。
          # TAURI_SIGNING_PRIVATE_KEY: PEM形式の秘密鍵（Base64可）
          # TAURI_SIGNING_PRIVATE_KEY_PASSWORD: 上記秘密鍵のパスワード
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}

      # ステップ6.5: アップデータ用latest.jsonの生成（Tauri 2.x対応）
      - name: Prepare updater assets and latest.json
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $tag = "${{ github.ref_name }}"  # 例: v0.2.16
          $version = $tag.TrimStart('v')
          $owner,$repo = "${{ github.repository }}".Split('/')

          # Tauri 2.xではNSISビルドの.exeファイルをupdater用に使用
          $nsisDir = "src-tauri/target/release/bundle/nsis"

          # NSISディレクトリが存在しない場合は警告を出してスキップ
          if (!(Test-Path $nsisDir)) {
            Write-Warning "NSIS build artifacts not found at $nsisDir"
            Write-Warning "This is expected if TAURI_SIGNING_PRIVATE_KEY is not configured."
            Write-Warning "Skipping latest.json generation."
            exit 0
          }

          # NSIS版の.exeファイルを取得
          $exe = Get-ChildItem $nsisDir -Filter *.exe | Select-Object -First 1
          if (-not $exe) {
            Write-Warning "No .exe file found under $nsisDir"
            exit 0
          }

          # 署名ファイル（.exe.sig）を読み取り
          $sigPath = "$($exe.FullName).sig"
          if (!(Test-Path $sigPath)) {
            Write-Warning "Signature file not found: $sigPath"
            Write-Warning "This is expected if TAURI_SIGNING_PRIVATE_KEY is not configured."
            exit 0
          }
          $signature = (Get-Content $sigPath -Raw).Trim()

          # リリースアセットのURL（この後のアップロードで同名ファイルを公開予定）
          $url = "https://github.com/$owner/$repo/releases/download/$tag/$($exe.Name)"
          $pubDate = (Get-Date).ToUniversalTime().ToString("yyyy-MM-ddTHH:mm:ssZ")

          $json = @{
            version = $version
            notes = "Automatic update for $tag"
            pub_date = $pubDate
            platforms = @{
              "windows-x86_64" = @{
                url = $url
                signature = $signature
              }
            }
          } | ConvertTo-Json -Depth 5

          Set-Content -Path "latest.json" -Value $json -Encoding UTF8
          Write-Host "Generated latest.json:"
          Write-Host $json

      # ステップ7: ビルド成果物をGitHub Releasesにアップロード
      # 注: 存在しないファイルパターンは自動的にスキップされます
      #     (署名鍵がない場合、.sigファイルとlatest.jsonは生成されません)
      - name: Upload Release Assets
        uses: softprops/action-gh-release@v2.0.9
        with:
          tag_name: ${{ github.ref_name }} # タグ名を使用（例: v0.2.16）
          name: Release ${{ github.ref_name }} # リリース名
          body: Windows installers for VDI-solid # リリース説明文
          draft: false # 公開リリース（下書きではない）
          prerelease: false # 正式リリース（プレリリースではない）
          files: |
            src-tauri/target/release/bundle/msi/*.msi
            src-tauri/target/release/bundle/msi/*.msi.sig
            src-tauri/target/release/bundle/nsis/*.exe
            src-tauri/target/release/bundle/nsis/*.exe.sig
            latest.json
        env:
          # GitHubの認証トークン（自動で設定）
          # このトークンによってReleasesページへの書き込み権限が有効化される
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

          