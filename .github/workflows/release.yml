# このワークフローは、タグがプッシュされたときにWindows向けのアプリケーションをビルドし、
# GitHub Releasesページに自動的にアップロードします

name: "Release"

# トリガー設定：v*.*.*形式のタグがプッシュされた時に実行
on:
  push:
    tags:
      - "v*.*.*" # 例: v0.2.7, v1.0.0

jobs:
  build-windows:
    # GitHub Releasesにアップロードするための権限を付与
    permissions:
      contents: write

    # Windows環境でビルドを実行
    runs-on: windows-latest

    steps:
      # ステップ1: リポジトリをチェックアウト
      - name: Checkout repository
        uses: actions/checkout@v4

      # ステップ2: Node.js環境をセットアップ（フロントエンドビルド用）
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: lts/* # 最新LTS版を使用
          cache: "npm" # npm キャッシュを有効化（高速化）

      # ステップ3: Rust 安定版ツールチェーンをインストール
      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable

      # ステップ4: Rustビルドのキャッシュを設定（高速化）
      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: "./src-tauri -> target" # src-tauri/targetをキャッシュ対象に指定

      # ステップ5: フロントエンドの依存パッケージをインストール
      - name: Install frontend dependencies
        run: npm ci # npm ci を使用（本番環境向けの安定インストール）

      # ステップ6: Tauriアプリケーションをビルド
      # このステップで以下のファイルが生成されます：
      #   - MSI インストーラ（src-tauri/target/release/bundle/msi/）
      #   - NSIS インストーラ（src-tauri/target/release/bundle/nsis/）
      - name: Build Tauri app
        run: npm run tauri build # リリースビルド（最適化有効）
        env:
          # アップデータ署名に使用する秘密鍵。リポジトリのSecretsに設定してください。
          # TAURI_SIGNING_PRIVATE_KEY: PEM形式の秘密鍵（Base64可）
          # TAURI_SIGNING_PRIVATE_KEY_PASSWORD: 上記秘密鍵のパスワード
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}

      # ステップ7: ビルド成果物をGitHub Releasesにアップロード
      # 注: 存在しないファイルパターンは自動的にスキップされます
      #     (署名鍵がない場合、.sigファイルとlatest.jsonは生成されません)
      - name: Upload Release Assets
        uses: softprops/action-gh-release@v2.0.9
        with:
          tag_name: ${{ github.ref_name }} # タグ名を使用（例: v0.2.16）
          name: Release ${{ github.ref_name }} # リリース名
          body: Windows installers for VDI-solid # リリース説明文
          draft: false # 公開リリース（下書きではない）
          prerelease: false # 正式リリース（プレリリースではない）
          files: |
            src-tauri/target/release/bundle/msi/*.msi
            src-tauri/target/release/bundle/msi/*.msi.sig
            src-tauri/target/release/bundle/nsis/*.exe
            src-tauri/target/release/bundle/nsis/*.exe.sig
        env:
          # GitHubの認証トークン（自動で設定）
          # このトークンによってReleasesページへの書き込み権限が有効化される
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-linux:
    # GitHub Releasesにアップロードするための権限を付与
    permissions:
      contents: write

    # Linux環境でビルドを実行
    runs-on: ubuntu-22.04

    steps:
      # ステップ1: リポジトリをチェックアウト
      - name: Checkout repository
        uses: actions/checkout@v4

      # ステップ2: Node.js環境をセットアップ（フロントエンドビルド用）
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: lts/* # 最新LTS版を使用
          cache: "npm" # npm キャッシュを有効化（高速化）

      # ステップ3: Rust 安定版ツールチェーンをインストール
      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable

      # ステップ4: Rustビルドのキャッシュを設定（高速化）
      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: "./src-tauri -> target" # src-tauri/targetをキャッシュ対象に指定

      # ステップ5: Linuxシステム依存関係のインストール
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libwebkit2gtk-4.1-dev \
            build-essential \
            curl \
            wget \
            file \
            libxdo-dev \
            libssl-dev \
            libayatana-appindicator3-dev \
            librsvg2-dev

      # ステップ6: フロントエンドの依存パッケージをインストール
      - name: Install frontend dependencies
        run: npm ci # npm ci を使用（本番環境向けの安定インストール）

      # ステップ7: Tauriアプリケーションをビルド
      # このステップで以下のファイルが生成されます：
      #   - DEB パッケージ（src-tauri/target/release/bundle/deb/）
      #   - AppImage（src-tauri/target/release/bundle/appimage/）
      - name: Build Tauri app
        run: npm run tauri build # リリースビルド（最適化有効）
        env:
          # アップデータ署名に使用する秘密鍵。リポジトリのSecretsに設定してください。
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}

      # ステップ8: ビルド成果物をGitHub Releasesにアップロード
      # 注: 存在しないファイルパターンは自動的にスキップされます
      #     (署名鍵がない場合、.sigファイルは生成されません)
      - name: Upload Release Assets
        uses: softprops/action-gh-release@v2.0.9
        with:
          tag_name: ${{ github.ref_name }} # タグ名を使用（例: v0.3.7）
          name: Release ${{ github.ref_name }} # リリース名
          body: Linux packages for VDI-solid # リリース説明文
          draft: false # 公開リリース（下書きではない）
          prerelease: false # 正式リリース（プレリリースではない）
          files: |
            src-tauri/target/release/bundle/deb/*.deb
            src-tauri/target/release/bundle/deb/*.deb.sig
            src-tauri/target/release/bundle/appimage/*.AppImage
            src-tauri/target/release/bundle/appimage/*.AppImage.sig
        env:
          # GitHubの認証トークン（自動で設定）
          # このトークンによってReleasesページへの書き込み権限が有効化される
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  generate-updater-json:
    # WindowsとLinuxのビルドが両方完了してから実行
    needs: [build-windows, build-linux]
    permissions:
      contents: write
    runs-on: ubuntu-22.04

    steps:
      # ステップ1: リポジトリをチェックアウト
      - name: Checkout repository
        uses: actions/checkout@v4

      # ステップ2: リリース情報から署名ファイルをダウンロード
      - name: Download release assets
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="${{ github.ref_name }}"
          REPO="${{ github.repository }}"

          # GitHub APIを使用してリリース情報を取得
          RELEASE_INFO=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
            "https://api.github.com/repos/$REPO/releases/tags/$TAG")

          # Windows .exe.sig ファイルをダウンロード
          WIN_SIG_URL=$(echo "$RELEASE_INFO" | jq -r '.assets[] | select(.name | endswith(".exe.sig")) | .browser_download_url' | head -1)
          WIN_EXE_URL=$(echo "$RELEASE_INFO" | jq -r '.assets[] | select(.name | endswith(".exe") and (. | contains(".sig") | not)) | .browser_download_url' | head -1)

          # Linux .AppImage.sig ファイルをダウンロード
          LINUX_SIG_URL=$(echo "$RELEASE_INFO" | jq -r '.assets[] | select(.name | endswith(".AppImage.sig")) | .browser_download_url' | head -1)
          LINUX_APPIMAGE_URL=$(echo "$RELEASE_INFO" | jq -r '.assets[] | select(.name | endswith(".AppImage") and (. | contains(".sig") | not)) | .browser_download_url' | head -1)

          # ダウンロード
          if [ -n "$WIN_SIG_URL" ] && [ "$WIN_SIG_URL" != "null" ]; then
            curl -L -o windows.exe.sig "$WIN_SIG_URL"
            echo "WIN_SIGNATURE=$(cat windows.exe.sig)" >> $GITHUB_ENV
            echo "WIN_URL=$WIN_EXE_URL" >> $GITHUB_ENV
          fi

          if [ -n "$LINUX_SIG_URL" ] && [ "$LINUX_SIG_URL" != "null" ]; then
            curl -L -o linux.AppImage.sig "$LINUX_SIG_URL"
            echo "LINUX_SIGNATURE=$(cat linux.AppImage.sig)" >> $GITHUB_ENV
            echo "LINUX_URL=$LINUX_APPIMAGE_URL" >> $GITHUB_ENV
          fi

      # ステップ3: latest.jsonを生成
      - name: Generate latest.json
        run: |
          TAG="${{ github.ref_name }}"
          VERSION="${TAG#v}"
          PUB_DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          # JSONファイルを生成
          cat > latest.json << EOF
          {
            "version": "$VERSION",
            "notes": "Automatic update for $TAG",
            "pub_date": "$PUB_DATE",
            "platforms": {
          EOF

          # Windowsプラットフォーム情報を追加
          if [ -n "$WIN_SIGNATURE" ]; then
            cat >> latest.json << EOF
              "windows-x86_64": {
                "url": "$WIN_URL",
                "signature": "$WIN_SIGNATURE"
              }
          EOF
            if [ -n "$LINUX_SIGNATURE" ]; then
              echo "," >> latest.json
            fi
          fi

          # Linuxプラットフォーム情報を追加
          if [ -n "$LINUX_SIGNATURE" ]; then
            cat >> latest.json << EOF
              "linux-x86_64": {
                "url": "$LINUX_URL",
                "signature": "$LINUX_SIGNATURE"
              }
          EOF
          fi

          # JSONを閉じる
          cat >> latest.json << EOF
            }
          }
          EOF

          echo "Generated latest.json:"
          cat latest.json

      # ステップ4: latest.jsonをリリースにアップロード
      - name: Upload latest.json
        uses: softprops/action-gh-release@v2.0.9
        with:
          tag_name: ${{ github.ref_name }}
          files: latest.json
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
