# ドラッグ操作パフォーマンス最適化 実装計画

## 計画名
`20251008_drag_performance`

## 概要
画像ドラッグ操作時のラグを解消するため、境界計算（`clampToBounds`）をキャッシュ化し、スケール変更時のみ再計算する最適化を実施する。これにより、マウスの動きに即座に追従しつつ、CPU負荷を大幅に削減する。

## 目的
- ドラッグ操作時のマウス追従を完璧に保つ
- 重い境界計算を最適化してCPU負荷を削減（20-30%改善目標）
- 既存機能（ズーム、回転、境界制約）との互換性を完全維持

## 技術スタック
- **フレームワーク**: SolidJS（リアクティブシステム）
- **最適化手法**: 計算結果のキャッシュ化
- **対象API**: `useBoundaryConstraint`フック

## 影響範囲

### 変更ファイル
- `src/components/ImageViewer/index.tsx`
  - `clampToBounds`関数の最適化
  - キャッシュ管理変数の追加
  - キャッシュクリアロジックの追加

### 新規ファイル
なし

### 影響を受けるファイル
- `src/hooks/useBoundaryConstraint.ts`（読み取りのみ、変更なし）
- `src/lib/boundaryUtils.ts`（読み取りのみ、変更なし）

## タスク一覧

### Phase 1: キャッシュ機構の実装（1.5時間）
- **Ticket #001**: 境界計算キャッシュの実装（High, 1.5h）

### Phase 2: キャッシュ無効化ロジック（1時間）
- **Ticket #002**: スケール・画像変更時のキャッシュクリア（High, 1h）

### Phase 3: テストと検証（0.5時間）
- **Ticket #003**: パフォーマンステストと動作確認（Medium, 0.5h）

## 依存関係図

```
#001 (キャッシュ実装)
  ↓
#002 (キャッシュ無効化)
  ↓
#003 (テスト)
```

**並行実行可能なタスク**: なし（順次実行）

## リスクと対策

### リスク1: キャッシュの不整合によるバグ
**対策**: 
- コンテナサイズ、スケール、回転角度、画像パスをキャッシュキーに含める
- `createEffect`で変更を監視し、確実にキャッシュをクリア

### リスク2: パフォーマンス改善が期待値に達しない
**対策**: 
- 実装前後でパフォーマンス測定を実施
- 必要に応じて追加の最適化を検討

### リスク3: 既存機能の後退
**対策**: 
- ズーム、回転、画像切り替えの動作を入念にテスト
- 境界制約が正しく機能することを確認

## 完了条件

- [ ] ドラッグ操作が滑らかで遅延がない
- [ ] `clampToBounds`の呼び出し回数が減少している（ログで確認）
- [ ] ズーム操作が正常に動作する
- [ ] 回転操作が正常に動作する
- [ ] 画像切り替え時に境界制約が正しく適用される
- [ ] コンテナリサイズ時に境界制約が正しく更新される
- [ ] 既存機能に後退がない

## 実装スケジュール

| Phase | タスク | 見積 | 担当 |
|-------|--------|------|------|
| Phase 1 | Ticket #001 | 1.5h | AI実装 |
| Phase 2 | Ticket #002 | 1h | AI実装 |
| Phase 3 | Ticket #003 | 0.5h | AI実装 |
| **合計** | - | **3h** | - |

## 参考資料
- Suggestファイル: `docs/suggest/20251008_drag_performance_optimization.md`
- 既存の境界制約実装: `src/hooks/useBoundaryConstraint.ts`
- 過去の計画（未実装）: Memory `drag_performance_optimization_plan`
