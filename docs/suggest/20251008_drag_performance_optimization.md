# ドラッグ操作パフォーマンス最適化 実装提案

## 作成日
2025-10-08

## 要望サマリー

### 何を
画像ドラッグ操作時のラグ（遅延・カクつき）を解消

### なぜ
現在のUIでドラッグ操作時に遅延を感じる。具体的にはマウスの動きに対して画像の追従が遅れ、操作性が悪い。

### どう（ユーザー提案）
処理速度を改善して滑らかなドラッグ操作を実現

## 確定した実装方針

### 採用方法
**I案: 境界計算の最適化（キャッシュ化）**

### 採用理由
1. **根本的な問題解決**: 重い境界計算を毎フレーム実行している問題を解決
2. **マウス追従の完璧性**: RAFによる遅延がなく、マウスの動きに即座に追従
3. **既存アーキテクチャの尊重**: SolidJSのリアクティブシステムを活用
4. **シンプルな実装**: 変更箇所が限定的でリスクが低い
5. **副作用が少ない**: 既存機能（ズーム、回転、境界制約）との互換性が高い

### 主要な技術選択

- **境界計算のキャッシュ化**: スケール変更時のみ`useBoundaryConstraint`を再計算
- **最適化戦略**: 計算結果を保持し、不要な再計算を削減
- **SolidJSシグナル**: 既存のリアクティブシステムをそのまま活用

## 大まかな実装内容

### 何をするか

1. **境界計算のキャッシュ機構実装**
   - `clampToBounds`関数内でキャッシュ変数を追加
   - スケール値の変化を検知
   - 変化がない場合はキャッシュを再利用

2. **キャッシュ無効化ロジック**
   - スケール変更時にキャッシュをクリア
   - 画像変更時にキャッシュをリセット
   - コンテナサイズ変更時にキャッシュを更新

3. **パフォーマンステスト**
   - ドラッグ操作の滑らかさを検証
   - CPU使用率の測定
   - 既存機能の互換性確認

### 影響を受ける領域

- `src/components/ImageViewer/index.tsx`の`clampToBounds`関数
- 同ファイル内のスケール変更関連処理（`handleWheelZoom`, `calculateAndSetScreenFit`）

### 新規作成が必要なもの

なし（既存ファイルの修正のみ）

### 変更が必要なもの

- `src/components/ImageViewer/index.tsx`

## 実装の制約条件

### 技術的制約
- SolidJSのリアクティブシステムとの整合性を保つ
- 既存の境界制約ロジックを変更しない
- ズーム、回転、画像切り替え時の動作を維持

### ビジネス制約
- ユーザー体験を損なわない
- 既存機能の後退を許容しない

### スケジュール制約
- 小規模な最適化のため、短時間（2-3時間）で完了

## リスクと対策

### リスク1: キャッシュの不整合
**内容**: スケール以外の要因（コンテナサイズ変更）でキャッシュが古くなる  
**対策**: コンテナサイズ変更時もキャッシュを無効化する仕組みを追加

### リスク2: 画像切り替え時の不具合
**内容**: 画像が変わってもキャッシュが残る  
**対策**: `createEffect`で画像パス変更を検知し、キャッシュをクリア

### リスク3: 回転時の境界計算エラー
**内容**: 回転角度変更時に境界計算が正しくない  
**対策**: 回転角度もキャッシュキーに含める

## 検討した代替案

### 案A: requestAnimationFrame（RAF）スロットリング
**メリット**: モニターのリフレッシュレートに自動適応  
**デメリット**: マウス追従に遅延が発生し、UIUX が悪化  
**不採用理由**: ユーザーからのフィードバックで「追従が遅れてUIUXが終わっている」と指摘

### 案H: 境界チェック遅延
**メリット**: 実装が最もシンプル  
**デメリット**: ドラッグ中に画像が境界を超える可能性  
**不採用理由**: 常に境界制約を効かせたい要件がある

### 案J: RAF + CSS Transform直接操作
**メリット**: GPU加速で最高のパフォーマンス  
**デメリット**: SolidJSのリアクティブシステムを部分的にバイパスし、保守性が低下  
**不採用理由**: アーキテクチャとの整合性を優先

## 次のステップ

この提案を基にPlan phaseで詳細な実装計画とチケットを作成します。

---

**提案者**: GitHub Copilot  
**レビュー**: ユーザー承認済み
