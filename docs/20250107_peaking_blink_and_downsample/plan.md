# ピーキング点滅機能とダウンサンプリング最適化 実装計画

**作成日**: 2025-01-07  
**計画名**: `20250107_peaking_blink_and_downsample`

---

## 概要

### 確定した実装方針

**目的**:
1. **ピーキング点滅機能**: 合焦箇所の視認性を向上させるため、ピーキング表示を点滅させる機能を追加
2. **ダウンサンプリング最適化**: 4K画像でのSobel処理（6秒）を、画像サイズに応じたダウンサンプリングにより高速化（目標: 1.5秒、4倍高速化）

### 採用理由
- **即効性**: 両機能とも1-3時間で実装可能
- **リスク最小**: GPU不要、既存技術のみで実現
- **コストパフォーマンス**: 小規模な変更で大きな効果
- **将来性**: GPU実装など、さらなる最適化の余地を残す

---

## 目的

### 機能1: ピーキング点滅機能
- 合焦箇所が点滅することで視認性向上
- ユーザーがON/OFF切り替え可能
- 点滅速度は固定（500ms間隔）

### 機能2: ダウンサンプリング最適化
- 高解像度画像（例: 4K）を処理前に縮小
- 処理速度を大幅改善（4K: 6秒 → 1.5秒）
- 視覚的な品質はほぼ維持（ピーキングは精密さより速度重視）

---

## 技術スタック

### フロントエンド
- **SolidJS**: リアクティブな点滅制御
- **TypeScript**: 型安全な実装

### バックエンド
- **Rust**: ダウンサンプリング処理
- **image crate**: 画像リサイズ機能（既存）
- **Rayon**: 並列処理（既存）

### 追加依存関係
なし（既存の依存関係のみ使用）

---

## 影響範囲

### 新規作成ファイル
なし

### 変更が必要なファイル

#### フロントエンド（点滅機能）
1. **src/context/AppStateContext.tsx**
   - `AppState`インターフェースに`peakingBlink: boolean`追加
   - 状態管理の追加

2. **src/components/SettingsMenu/index.tsx**
   - チェックボックス追加「ピーキング点滅」
   - ハンドラー追加

3. **src/components/ImageViewer/PeakingLayer.tsx**
   - 点滅ロジック実装（setInterval）
   - onCleanupでクリーンアップ

#### バックエンド（ダウンサンプリング）
4. **src-tauri/src/peaking.rs**
   - 画像サイズチェック追加
   - 閾値以上ならダウンサンプリング
   - ダウンサンプル後のSobel処理
   - 座標スケールバック

### 影響を受けるファイル
- **src/components/ImageViewer/index.tsx**: Props経由でpeakingBlinkを渡す（軽微）
- **src/components/ImageViewer/ImageManager.tsx**: Props経由でpeakingBlinkを渡す（軽微）

---

## タスク一覧

### Phase 1: 基盤準備（並行可能）

**Ticket #001**: AppStateContextに点滅設定を追加
- 優先度: High
- 見積: 0.5時間
- 依存: なし

**Ticket #002**: ダウンサンプリングロジックの実装（Rust）
- 優先度: High
- 見積: 1.5時間
- 依存: なし

### Phase 2: UI実装

**Ticket #003**: SettingsMenuに点滅チェックボックス追加
- 優先度: Medium
- 見積: 0.5時間
- 依存: #001

**Ticket #004**: PeakingLayerに点滅ロジック実装
- 優先度: High
- 見積: 1時間
- 依存: #001

### Phase 3: 統合とテスト

**Ticket #005**: 統合テストと動作確認
- 優先度: High
- 見積: 1時間
- 依存: #002, #003, #004

---

## 依存関係図

```
Phase 1 (並行可能)
├── Ticket #001: AppStateContext拡張
└── Ticket #002: ダウンサンプリング実装

Phase 2 (Phase 1完了後)
├── Ticket #003: SettingsMenu拡張 (依存: #001)
└── Ticket #004: 点滅ロジック実装 (依存: #001)

Phase 3 (Phase 2完了後)
└── Ticket #005: 統合テスト (依存: #002, #003, #004)
```

**クリティカルパス**: #001 → #004 → #005  
**並行実行可能**: #001と#002, #003と#004

---

## リスクと対策

### リスク1: 点滅が目障りに感じる可能性
**影響度**: 低  
**対策**:
- デフォルトはOFF
- ユーザーが自由にON/OFF切り替え可能
- 点滅間隔は500msで適度な速度

### リスク2: ダウンサンプリングで視覚品質低下
**影響度**: 低  
**対策**:
- 閾値を適切に設定（例: 2000px以上）
- 縮小率は2倍程度に抑える（4K→HD）
- ピーキングは精密さより速度重視の用途

### リスク3: 小さい画像での処理速度低下
**影響度**: 極小  
**対策**:
- ダウンサンプリング閾値以下はそのまま処理
- 既存の高速処理を維持

### リスク4: メモリ使用量の増加
**影響度**: 極小  
**対策**:
- ダウンサンプリング後の画像は一時的なメモリのみ
- 処理完了後は自動解放

---

## 完了条件

### 機能要件
- ✅ ピーキング点滅のON/OFF切り替えが可能
- ✅ 点滅が500ms間隔で動作
- ✅ 高解像度画像（例: 4K）の処理時間が1.5秒以下
- ✅ 低解像度画像の処理速度が維持される
- ✅ キャッシュ機構が正常に動作

### 非機能要件
- ✅ TypeScriptコンパイルエラーなし
- ✅ Rustビルドエラーなし
- ✅ 既存機能への影響なし
- ✅ メモリリークなし

### ユーザー体験
- ✅ 点滅により合焦箇所が見やすい
- ✅ 4K画像でも快適な操作性
- ✅ 設定が直感的

---

## パフォーマンス目標

### Before（現状）
```
低解像度（1280x720）: 爆速（数十ms）
4K画像（3840x2160）: 約6秒
```

### After（目標）
```
低解像度（1280x720）: 爆速維持（数十ms）
4K画像（3840x2160）: 約1.5秒（4倍高速化）
```

### ダウンサンプリング戦略
```
画像サイズ判定:
- 幅または高さが2000px未満 → そのまま処理
- 幅または高さが2000px以上 → HD（1920x1080）にダウンサンプリング

理由:
- 4K（3840x2160）をHD（1920x1080）に縮小 → ピクセル数1/4
- 処理時間もほぼ1/4に短縮
- ピーキングの視認性は十分維持
```

---

## 実装時の注意事項

### 点滅機能
1. **メモリリーク防止**
   - `setInterval`は必ず`clearInterval`で解放
   - SolidJSの`onCleanup`を使用

2. **パフォーマンス**
   - 点滅中も他の操作をブロックしない
   - リアクティブな制御で最小限の再レンダリング

### ダウンサンプリング
1. **座標スケール**
   - ダウンサンプリング後のエッジ座標を元のサイズにスケールバック
   - 縮小率を正確に記録・適用

2. **品質維持**
   - 適切なリサイズアルゴリズム（Lanczos3等）
   - 閾値の適切な設定

3. **既存キャッシュ**
   - キャッシュキーは変更不要
   - ダウンサンプリングは透過的に動作

---

## 次のステップ

この計画を基に各チケットを順次実装します。

**推奨実行順序**:
1. Phase 1: Ticket #001 + #002（並行）
2. Phase 2: Ticket #003 + #004（#001完了後、並行可）
3. Phase 3: Ticket #005（全て完了後）

**合計見積時間**: 4.5時間
