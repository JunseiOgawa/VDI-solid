# Ticket #005: 統合テストと動作確認

**日付**: 2025-01-07  
**担当**: Agent  
**優先度**: High  
**見積時間**: 1時間  
**依存**: Ticket #002, #003, #004

---

## 概要

点滅機能とダウンサンプリング機能の統合テストを実施し、全機能が正常に動作することを確認します。

---

## 目的

- 点滅機能とダウンサンプリング機能の統合動作確認
- パフォーマンス改善効果の測定
- エッジケースのテスト
- リグレッションテスト（既存機能への影響確認）

---

## テスト環境

### 必要な画像サンプル

#### 1. 低解像度画像（1280x720）
- ファイル: `test_lowres.jpg`
- 目的: ダウンサンプリングが発生しないことを確認

#### 2. Full HD画像（1920x1080）
- ファイル: `test_fullhd.jpg`
- 目的: ダウンサンプリング境界値のテスト

#### 3. 4K画像（3840x2160）
- ファイル: `test_4k.jpg`
- 目的: ダウンサンプリングとパフォーマンス改善の確認

#### 4. 縦長画像（1080x3840）
- ファイル: `test_vertical.jpg`
- 目的: 縦横比が異なる画像での動作確認

---

## テスト計画

### Phase 1: 個別機能テスト（20分）

#### テスト1-1: 点滅機能（単体）
**手順**:
1. アプリケーション起動
2. 低解像度画像を開く（ダウンサンプリングを回避）
3. ピーキング有効化
4. 点滅チェックボックスをON

**期待結果**:
- ✅ ピーキング表示が500ms間隔で点滅
- ✅ 点滅チェックボックスをOFFで点滅停止
- ✅ ブラウザコンソールに`[PeakingLayer] Blink toggle: true/false`が交互に表示

#### テスト1-2: ダウンサンプリング機能（単体）
**手順**:
1. 4K画像を開く
2. ピーキング有効化
3. Rustコンソールログを確認

**期待結果**:
- ✅ `[Downsample] 3840x2160 -> 1920x1080 (scale: 0.50)`が表示
- ✅ `[ScaleBack] Applying scale: x=2.00, y=2.00`が表示
- ✅ 処理時間が1.5秒以下
- ✅ エッジが正しく描画される

---

### Phase 2: 統合テスト（25分）

#### テスト2-1: 点滅 + ダウンサンプリング
**手順**:
1. 4K画像を開く
2. ピーキング有効化
3. 点滅チェックボックスをON

**期待結果**:
- ✅ ダウンサンプリングが実行される
- ✅ エッジが正しく描画される
- ✅ エッジが500ms間隔で点滅する
- ✅ 処理時間が1.5秒以下

#### テスト2-2: 画像サイズ別動作
| 画像サイズ | ダウンサンプリング | 処理時間目標 | 点滅動作 |
|----------|--------------|-----------|--------|
| 1280x720 | なし | 数十ms | ✅ |
| 1920x1080 | なし | 数百ms | ✅ |
| 3840x2160 | あり | 1.5秒以下 | ✅ |
| 1080x3840 | あり | 1.5秒以下 | ✅ |

#### テスト2-3: 設定値変更時の挙動
**手順**:
1. 4K画像を開く
2. ピーキング有効化、点滅ON
3. 強度を100に変更
4. 強度を200に変更
5. 色を赤（#ff0000）に変更
6. 不透明度を0.8に変更

**期待結果**:
- ✅ 各変更でキャンセル機能が正常に動作
- ✅ 新しい設定でエッジが再計算される
- ✅ 点滅が継続して動作
- ✅ ダウンサンプリングが毎回実行される

---

### Phase 3: リグレッションテスト（15分）

#### テスト3-1: 既存のピーキング機能
**確認項目**:
- ✅ ピーキング有効/無効切り替え
- ✅ 強度スライダーの動作
- ✅ 色選択の動作
- ✅ 不透明度スライダーの動作
- ✅ キャッシュ機能の動作
- ✅ キャンセル機能の動作

#### テスト3-2: 他の機能への影響
**確認項目**:
- ✅ 画像の読み込み・表示
- ✅ 画像の回転・拡大縮小
- ✅ 他の設定メニュー項目
- ✅ グリッドオーバーレイ
- ✅ フッター表示

---

### Phase 4: エッジケーステスト（10分）

#### テスト4-1: 高速切り替え
**手順**:
1. 4K画像を開く
2. 点滅チェックボックスを連続で5回ON/OFF切り替え

**期待結果**:
- ✅ メモリリークなし
- ✅ タイマーが正しくクリーンアップされる
- ✅ 状態が正しく反映される

#### テスト4-2: 画像の高速切り替え
**手順**:
1. 複数の4K画像を用意
2. 点滅ON状態で画像を高速に切り替え（5回）

**期待結果**:
- ✅ メモリリークなし
- ✅ 各画像でダウンサンプリングが正しく実行
- ✅ 点滅が正常に動作

#### テスト4-3: ピーキング無効化中の点滅設定
**手順**:
1. ピーキング無効状態で点滅チェックボックスをON
2. ピーキング有効化

**期待結果**:
- ✅ ピーキング有効化と同時に点滅開始
- ✅ エラーなし

---

## パフォーマンス測定

### 測定項目

#### 処理時間
```
測定方法: Rustコンソールログの処理時間を記録

Before（Phase 4実装後）:
- 1280x720: ~50ms
- 1920x1080: ~300ms
- 3840x2160: ~6000ms

After（ダウンサンプリング実装後）:
- 1280x720: ~50ms（変化なし）
- 1920x1080: ~300ms（変化なし）
- 3840x2160: ~1500ms（4倍高速化）
```

#### メモリ使用量
```
測定方法: ブラウザ開発者ツール > Performance Monitor

点滅OFF時のベースライン: XXX MB
点滅ON時（5分間動作）: XXX MB
差分: 数MB以内であること（メモリリーク防止確認）
```

#### CPU使用率
```
測定方法: ブラウザ開発者ツール > Performance Monitor

点滅OFF時: X%
点滅ON時: X%
差分: 1%以内であること（setIntervalのオーバーヘッドは最小）
```

---

## 完了条件

### 機能要件
- ✅ 点滅機能が正常に動作（500ms間隔）
- ✅ ダウンサンプリング機能が正常に動作（4K画像で1.5秒以下）
- ✅ 低解像度画像でダウンサンプリングが発生しない
- ✅ 点滅とダウンサンプリングが同時に動作
- ✅ 設定変更時に正しく反映される

### 非機能要件
- ✅ メモリリークなし
- ✅ CPU使用率が過度に上昇しない
- ✅ 既存機能に影響なし
- ✅ TypeScriptコンパイルエラーなし
- ✅ Rustビルドエラーなし

### パフォーマンス要件
- ✅ 4K画像の処理時間: 6秒 → 1.5秒（4倍高速化達成）
- ✅ 低解像度画像の処理時間: 変化なし
- ✅ 点滅のオーバーヘッド: 1%以内

---

## バグ発見時の対応

### バグ報告フォーマット
```
# バグ報告

## 再現手順
1. ...
2. ...

## 期待される動作
...

## 実際の動作
...

## 環境
- OS: Windows/macOS/Linux
- ブラウザ: Chrome/Edge/Firefox
- 画像サイズ: XXXXxXXXX

## ログ
[コンソールログを添付]
```

### バグ修正フロー
1. バグを再現
2. 原因を特定
3. 修正実装
4. 該当テストケースを再実行
5. リグレッションテストを再実行

---

## テスト結果ドキュメント

### 作成するドキュメント
- `docs/20250107_peaking_blink_and_downsample/test_result.md`

### 記録内容
- 各テストケースの結果（✅/❌）
- パフォーマンス測定結果
- 発見されたバグとその修正内容
- スクリーンショット（必要に応じて）

---

## 次のステップ

### 全テスト合格後
1. テスト結果ドキュメントを作成
2. ユーザーに報告
3. 必要に応じて調整・改善

### バグ発見時
1. バグチケットを作成
2. 修正実装
3. テストを再実行

---

## 注意事項

### テスト時の注意
- **ログレベル**: デバッグログを有効化
- **画像サンプル**: 実際の使用シーンに近い画像を使用
- **環境**: 開発環境とビルド版の両方でテスト

### パフォーマンス測定の注意
- ブラウザキャッシュをクリアして測定
- 複数回測定して平均を取る
- バックグラウンドプロセスの影響を最小化

### リグレッションテストの重要性
- 新機能追加により既存機能が壊れていないことを確認
- 特にキャッシュ機能とキャンセル機能は重要

---

## 参考情報

### テスト駆動開発（TDD）のサイクル
```
Red: テスト失敗（期待動作を定義）
 ↓
Green: 実装して合格
 ↓
Refactor: コードを整理
 ↓
繰り返し
```

### パフォーマンス測定ツール
- **Chrome DevTools**: Performance Monitor, Performance タブ
- **Rust**: `println!("[Timer] Processing took: {:.2}s", elapsed.as_secs_f64())`
- **メモリプロファイラ**: Heap Snapshot

### 品質保証チェックリスト
- [ ] 全テストケースが合格
- [ ] パフォーマンス目標を達成
- [ ] メモリリークなし
- [ ] CPU使用率が許容範囲内
- [ ] 既存機能に影響なし
- [ ] ドキュメント作成完了
