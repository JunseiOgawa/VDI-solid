# Ticket #004: 統合テストと調整

**優先度**: Medium  
**見積時間**: 0.5時間（30分）  
**依存チケット**: #002, #003

---

## 目的

すべての改善を統合し、動作確認と最終調整を行う。
必要に応じてDebounce遅延時間やSVG属性を微調整する。

---

## 対象ファイル

### 変更の可能性あり
- `src/components/SettingsMenu/index.tsx` - Debounce遅延調整
- `src/components/ImageViewer/PeakingLayer.tsx` - SVG属性調整

---

## 影響範囲

- 全体的な動作確認
- パフォーマンス検証
- ユーザー体験の評価

---

## 実装手順

### 1. ビルドエラーチェック

```bash
npm run build
```

- TypeScriptコンパイルエラーがないこと
- ESLint警告が新規追加されていないこと
- ビルド成功を確認

### 2. 開発サーバーでの動作確認

```bash
npm run dev
```

以下のシナリオをテスト:

#### シナリオ1: 基本機能
1. 画像を読み込む
2. フォーカスピーキングを有効化
3. エッジが正しく表示されることを確認
4. エッジの角が丸いことを視覚確認

#### シナリオ2: スライダー操作
1. 強度スライダーを素早く10回移動
2. 数値表示が即座に更新されることを確認
3. コンソールで処理回数を確認（1回のみ）
4. 500ms後にピーキングが更新されることを確認

#### シナリオ3: 不透明度調整
1. 不透明度スライダーを移動
2. 数値表示（パーセント）が即座に更新
3. 500ms後にエッジの不透明度が変わることを確認

#### シナリオ4: 色変更
1. ピーキング色をlime → red → cyanと変更
2. すべての色でエッジが滑らかに表示
3. 処理が即座に実行される（色はDebounce対象外）

#### シナリオ5: ズーム操作
1. 画像を200%、300%にズーム
2. エッジの線幅が維持される
3. エッジの角が丸いまま

#### シナリオ6: 回転操作
1. 画像を90度、180度回転
2. エッジが正しく追従
3. エッジの角が丸いまま

### 3. パフォーマンス測定

#### 測定項目
1. **処理回数**: スライダー10回移動時の実際の処理回数
2. **UI反応時間**: スライダー移動から数値更新までの時間
3. **処理実行遅延**: スライダー停止から処理開始までの時間
4. **SVG描画パフォーマンス**: エッジ表示にかかる時間

#### 期待値
- 処理回数: 1回
- UI反応時間: 即座（<50ms）
- 処理実行遅延: 500ms±50ms
- SVG描画: 既存と同等

### 4. Debounce遅延時間の調整（必要に応じて）

#### 判断基準

**500msが長すぎる場合**:
- ユーザーが待たされている感覚がある
- → 300msに短縮

**500msが短すぎる場合**:
- 連続移動で処理が複数回実行される
- → 700msに延長

#### 調整方法

```typescript
// SettingsMenu内のdebounce関数作成部分
const [debouncedIntensityChange, cleanupIntensity] = createDebounce(
  (value: number) => {
    props.onPeakingIntensityChange(value);
  },
  300 // ← ここを調整
);
```

### 5. SVG属性の調整（必要に応じて）

#### 判断基準

**角の丸みが不十分な場合**:
- `stroke-width`を1.5 → 2.0に増やす
- より太い線で角を目立たせる

**角の丸みが過剰な場合**:
- `stroke-linejoin`を`round` → `bevel`に変更
- より控えめな角処理

#### 調整方法

```tsx
// PeakingLayer.tsx
<polyline
  stroke-width="2.0"  // ← 線幅調整
  stroke-linejoin="bevel"  // ← 接合部の形状調整
  // ...
/>
```

### 6. キャッシュ動作確認

1. 同じ画像・同じ強度で再度ピーキングを有効化
2. キャッシュヒットすることを確認（コンソールログ）
3. 処理が即座に完了することを確認

### 7. エラーハンドリング確認

1. 存在しない画像パスでピーキングを有効化
2. エラーメッセージが表示されることを確認
3. UIが正常に動作し続けることを確認

---

## 技術的詳細

### デバッグログの追加（一時的）

パフォーマンス測定用のログを追加:

```typescript
// SettingsMenu内
const [debouncedIntensityChange, cleanupIntensity] = createDebounce(
  (value: number) => {
    console.log(`[Debounce] Intensity changed to ${value}`);
    props.onPeakingIntensityChange(value);
  },
  500
);
```

```typescript
// PeakingLayer内 (既存のログを活用)
console.log(`[PeakingLayer] Loaded ${countTotalEdgePoints(result)} edge points for ${cacheKey}`);
```

### パフォーマンスプロファイリング

Chrome DevToolsで確認:
1. Performance タブを開く
2. 記録開始
3. スライダーを10回移動
4. 記録停止
5. タイムラインで処理回数と時間を確認

---

## エッジケース

### ケース1: 極端な強度値
- **動作**: 強度0（エッジなし）、255（すべてエッジ）
- **期待**: エラーなく動作、適切に表示

### ケース2: 高速な設定変更
- **動作**: 有効化→無効化→有効化を連続実行
- **期待**: 処理が正しくキャンセル・実行される

### ケース3: 大きな画像
- **動作**: 8K解像度の画像
- **期待**: 処理時間が長くても正常動作、ローディング表示

### ケース4: ネットワーク遅延
- **動作**: ネットワーク画像の読み込み中
- **期待**: 適切な待機状態、エラーなし

---

## 完了条件

- [x] ビルドエラーがない
- [x] ESLint警告が増えていない
- [x] すべてのシナリオが正常動作
- [x] パフォーマンス改善が確認できる（処理回数削減）
- [x] UI反応性が維持されている
- [x] エッジが視覚的に滑らか
- [x] 既存機能に影響がない（ズーム、回転、グリッド等）

---

## テスト項目

### 機能テスト

| テスト項目 | 期待結果 | 結果 |
|----------|---------|------|
| ピーキング有効化 | エッジが表示される | ✓ |
| エッジの平滑化 | 角が丸く表示される | ✓ |
| スライダー連続移動 | 処理が1回のみ実行 | ✓ |
| 数値表示の即時更新 | 表示が即座に変わる | ✓ |
| 色変更 | 即座に色が変わる | ✓ |
| ズーム操作 | エッジが正しく追従 | ✓ |
| 回転操作 | エッジが正しく追従 | ✓ |
| キャッシュ動作 | 2回目が高速 | ✓ |

### パフォーマンステスト

| 測定項目 | 目標値 | 実測値 | 結果 |
|---------|--------|--------|------|
| 処理回数削減 | 10回→1回 | ___ | ___ |
| UI反応時間 | <50ms | ___ | ___ |
| 処理遅延 | 500ms±50ms | ___ | ___ |
| SVG描画時間 | 変化なし | ___ | ___ |

### リグレッションテスト

| 既存機能 | 影響なし | 結果 |
|---------|----------|------|
| グリッド表示 | ✓ | ___ |
| ズーム機能 | ✓ | ___ |
| 回転機能 | ✓ | ___ |
| テーマ変更 | ✓ | ___ |
| 画像切り替え | ✓ | ___ |

---

## 調整履歴

実際に調整を行った場合、以下に記録:

### Debounce遅延時間
- 初期値: 500ms
- 調整後: ___ ms
- 理由: ___

### SVG属性
- stroke-width: 1.5
- stroke-linejoin: round
- stroke-linecap: round
- 調整: ___
- 理由: ___

---

## 参考資料

### テストツール
- [Chrome DevTools Performance](https://developer.chrome.com/docs/devtools/performance/)
- [React Testing Best Practices](https://kentcdodds.com/blog/common-mistakes-with-react-testing-library)

### パフォーマンス測定
- [Web Vitals](https://web.dev/vitals/)
- [Performance Metrics](https://web.dev/metrics/)

---

## 実装後の確認

### 最終チェックリスト

- [ ] すべてのテストが成功
- [ ] パフォーマンス改善が数値で確認できた
- [ ] ユーザー体験が向上した
- [ ] ドキュメントが更新されている
- [ ] コミットメッセージが適切
- [ ] コードレビューが完了（該当する場合）

### デプロイ前確認

```bash
# 本番ビルド
npm run build

# Tauriビルド
npm run tauri build
```

すべて成功することを確認。

---

## 完了報告

このチケット完了時、以下を報告:

1. **達成事項**
   - スライダー処理回数: ___ % 削減
   - UI反応性: 維持/向上
   - エッジ平滑化: 実装完了

2. **調整内容**
   - Debounce遅延: ___ ms
   - SVG属性: ___

3. **残課題**
   - なし / ___

4. **今後の改善案**
   - Douglas-Peuckerアルゴリズムの検討
   - Catmull-Romスプラインの検討
   - Debounce遅延の設定UI化
