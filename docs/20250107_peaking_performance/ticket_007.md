# Ticket #007: パフォーマンステストと調整

**作成日**: 2025-01-07  
**優先度**: Medium  
**見積時間**: 0.75時間  
**担当**: フロントエンド + Rust  
**依存関係**: Ticket #004（エッジ抽出並列化）, Ticket #006（AbortController統合）  

---

## 目的

すべての最適化を統合した状態でパフォーマンスを測定し、
目標（4~5倍の体感高速化）を達成していることを確認する。

必要に応じて微調整を行い、最適なユーザー体験を提供する。

---

## テスト項目

### 1. 単一処理の速度測定

**目的**: 並列化による高速化を確認

**手順**:
1. 開発サーバーを起動
2. 1920x1080の画像を読み込み
3. 強度を100に設定
4. Rustのログから処理時間を記録

**計測項目**:
- 画像読み込み時間
- Sobelフィルタ時間
- エッジ抽出時間
- 合計処理時間

**目標値**:
```
Before (Phase 4完了時点):
- Sobelフィルタ: 約450ms
- エッジ抽出: 約350ms
- 合計: 約1000ms

After (並列化後):
- Sobelフィルタ: 150-200ms（50-55%削減）
- エッジ抽出: 100-150ms（60-70%削減）
- 合計: 400-500ms（50-60%削減）
```

### 2. 連続操作のテスト

**目的**: AbortControllerによるキャンセルを確認

**手順**:
1. スライダーを素早く150→155→160→165→200と変更
2. ターミナルログを確認
3. 最後の値（200）のみが処理されることを確認

**期待される動作**:
```
[PeakingLayer] 前回のリクエストをキャンセル
[Rust] Cancelled
[PeakingLayer] 前回のリクエストをキャンセル
[Rust] Cancelled
[PeakingLayer] 前回のリクエストをキャンセル
[Rust] Cancelled
[PeakingLayer] 前回のリクエストをキャンセル
[Rust] Cancelled
[Peaking] 合計処理時間: 400ms
[PeakingLayer] ピーキングデータ更新完了
```

**目標値**:
```
Before:
- 5回の処理がすべて実行
- 合計: 5 × 1000ms = 5000ms

After:
- 1回のみ処理
- 合計: 400ms（体感12倍高速化）
```

### 3. 画像サイズ別のテスト

**目的**: 様々な画像サイズで安定動作を確認

**テストケース**:
| サイズ | 目標処理時間 |
|--------|-------------|
| 640x480 (VGA) | 50-100ms |
| 1280x720 (HD) | 150-250ms |
| 1920x1080 (Full HD) | 400-500ms |
| 3840x2160 (4K) | 1500-2000ms |

### 4. メモリ使用量の確認

**目的**: 並列化によるメモリ増加が許容範囲内であることを確認

**手順**:
1. Windowsタスクマネージャーを開く
2. アプリケーションのメモリ使用量を記録
3. 大きい画像（4K）で処理を実行
4. ピーク時のメモリを記録

**目標値**:
- ベースライン: 約100MB
- 4K画像処理時: 250MB以下（150MB増加まで許容）

### 5. CPU使用率の確認

**目的**: マルチコアを活用できていることを確認

**手順**:
1. Windowsタスクマネージャーの「パフォーマンス」タブを開く
2. CPU使用率を確認
3. 処理中に複数のコアが使われていることを確認

**期待される動作**:
- Before: 1コアのみ100%使用
- After: 複数コア（4-8コア）が50-70%使用

---

## 調整項目

### 調整1: Rayonのスレッド数

デフォルトはCPUコア数だが、必要に応じて制限:

```rust
use rayon::ThreadPoolBuilder;

// メイン関数で設定
fn main() {
    ThreadPoolBuilder::new()
        .num_threads(4)  // 最大4スレッド
        .build_global()
        .unwrap();
    
    tauri::Builder::default()
        // ...
}
```

**調整基準**:
- CPUコア数が2-4の場合: デフォルトのまま
- CPUコア数が8以上の場合: 6-8スレッドに制限（メモリ効率化）

### 調整2: デバウンス時間

現在500msだが、体感に応じて調整:

**ファイル**: `src/components/SettingsMenu/index.tsx`

```typescript
const [debouncedIntensityChange, cleanupIntensity] = createDebounce(
  (value: number) => props.onPeakingIntensityChange(value),
  300  // 500ms → 300msに短縮（オプション）
);
```

**調整基準**:
- 処理が十分速い場合（300ms以下）: 300msに短縮
- 処理がまだ重い場合（500ms以上）: 700msに延長

### 調整3: キャッシュサイズ

現在10件だが、メモリに余裕がある場合は増やす:

**ファイル**: `src/components/ImageViewer/PeakingLayer.tsx`

```typescript
if (cache.size > 20) {  // 10 → 20に拡大
  const firstKey = cache.keys().next().value;
  cache.delete(firstKey);
}
```

**調整基準**:
- メモリ使用量が200MB以下: 20件に増加
- メモリ使用量が300MB以上: 5件に削減

---

## タスク

### 1. パフォーマンス計測の実施

- [ ] 単一処理速度の測定（3回平均）
- [ ] 連続操作のテスト
- [ ] 画像サイズ別のテスト
- [ ] メモリ使用量の記録
- [ ] CPU使用率の確認

### 2. 結果の記録

**ファイル**: `docs/20250107_peaking_performance/performance_analysis.md`

```markdown
# パフォーマンス分析結果

## 最終計測結果（Phase 2-3完了後）

### テスト環境
- CPU: [記録]
- メモリ: [記録]
- OS: Windows
- Rust: [バージョン]
- Rayon: 1.8

### 単一処理速度（1920x1080, threshold=100）

| 処理 | Before | After | 削減率 |
|------|--------|-------|--------|
| 画像読み込み | XXXms | XXXms | X% |
| Sobelフィルタ | XXXms | XXXms | XX% |
| エッジ抽出 | XXXms | XXXms | XX% |
| **合計** | XXXms | XXXms | **XX%** |

### 連続操作（150→155→160→165→200）

| 項目 | Before | After | 改善率 |
|------|--------|-------|--------|
| 実行された処理数 | 5回 | 1回 | - |
| 合計時間 | XXXXms | XXXms | XX% |

### メモリ使用量

| 画像サイズ | Before | After | 増加量 |
|-----------|--------|-------|--------|
| VGA | XXmb | XXmb | +XXmb |
| HD | XXmb | XXmb | +XXmb |
| Full HD | XXmb | XXmb | +XXmb |
| 4K | XXmb | XXmb | +XXmb |

### CPU使用率

- Before: 1コア 100%使用
- After: X個のコアが平均XX%使用

## 結論

[目標達成状況と総評を記載]
```

### 3. 調整の実施（必要に応じて）

- [ ] スレッド数の調整
- [ ] デバウンス時間の調整
- [ ] キャッシュサイズの調整

### 4. 最終動作確認

- [ ] TypeScriptコンパイルエラーなし
- [ ] Rustビルドエラーなし
- [ ] UI反応性が良好
- [ ] エラーハンドリングが適切

---

## 完了条件

- ✅ すべてのテストケースが完了
- ✅ `performance_analysis.md`に結果が記録されている
- ✅ 目標値を達成している（または近い値）
- ✅ 調整が必要な場合は実施済み
- ✅ 最終動作確認完了
- ✅ ドキュメント更新完了

---

## 成功基準

### 最低基準（MUST）
- ✅ 単一処理速度が40%以上削減
- ✅ 連続操作時のキャンセルが機能
- ✅ メモリ増加が300MB以下
- ✅ エラーなく動作

### 推奨基準（SHOULD）
- ✅ 単一処理速度が50%以上削減
- ✅ 連続操作時の体感が5倍以上向上
- ✅ メモリ増加が200MB以下
- ✅ 複数コアを活用

### 理想基準（NICE TO HAVE）
- ✅ 単一処理速度が60%以上削減
- ✅ 連続操作時の体感が10倍以上向上
- ✅ メモリ増加が150MB以下
- ✅ すべてのCPUコアをバランス良く活用

---

## 次のステップ

このチケット完了後、C案の実装はすべて完了。

**最終確認事項**:
1. すべてのチケットのクローズ確認
2. ドキュメントの整理
3. ユーザーへの報告
4. 今後の改善点の記録

---

## 参考情報

### パフォーマンス計測ツール
- Windowsタスクマネージャー: メモリ・CPU確認
- Chrome DevTools: ネットワーク・タイミング確認
- Rustのprintln!: 処理時間のログ出力

### 最適化のチェックリスト
- [ ] 並列処理が機能している
- [ ] キャンセル処理が機能している
- [ ] キャッシュが機能している
- [ ] デバウンスが機能している
- [ ] メモリリークがない
- [ ] エラーハンドリングが適切
- [ ] ログが適切に出力される
