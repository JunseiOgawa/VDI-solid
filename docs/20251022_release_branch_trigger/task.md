# Release ブランチトリガーへの変更 - タスクリスト

## タスク一覧

### 1. ドキュメント作成
- [x] design.md の作成
- [x] task.md の作成

### 2. ワークフロー修正（第1回）
- [x] release.yml のトリガーブランチを release に変更（L9）
- [x] release.yml のプッシュ先を release に変更（L92）

### 3. 確認
- [x] 変更内容の確認
- [x] ユーザーへの確認依頼

### 4. バグ修正（第2回）
- [x] L92のプッシュ先が残っていた問題を修正
- [x] releaseジョブが実行されない問題を調査
- [x] ジョブ依存関係の論理矛盾を特定
- [x] `needs: version`を削除（L97）
- [x] バージョン情報取得ステップを追加（L118-127）
- [x] 環境変数への参照を変更（L132-134, L180-183）
- [x] コメント番号の整合性を修正

### 5. ドキュメント更新
- [x] design.mdに発見された問題を追記
- [x] design.mdに追加の変更箇所を記載
- [x] task.mdに詳細な修正履歴を追記

### 6. バグ修正（第3回）
- [x] releaseジョブがスキップされる問題を調査
- [x] `[skip ci]`が原因であることを特定
- [x] L87から`[skip ci]`を削除
- [x] ドキュメントを更新

### 7. CDの動作フローを詳細にドキュメント化
- [x] 全体の流れを図解
- [x] versionジョブの詳細な動作を記述
- [x] releaseジョブの詳細な動作を記述
- [x] 成果物の公開プロセスを説明
- [x] 重要な注意事項（無限ループ防止、タグ作成タイミングなど）を記載
- [x] 実際の運用例を4ケース追加
- [x] トラブルシューティングガイドを追加

### 8. 最終的な設計の見直し
- [x] ユーザーからの指摘: 同時処理のことを考えていない
- [x] 問題認識: `needs: version`と`always()`を使うと、無駄な依存関係が生まれる
- [x] 最終決定: versionジョブとreleaseジョブを完全に独立させる
- [x] releaseジョブから`needs`と`always()`を削除
- [x] 元のシンプルな条件`if: ${{ contains(..., 'bump version') }}`のみを使用
- [x] ドキュメントを更新（シンプルで効率的な設計に変更）

## 進捗管理

現在の状態: 全ての修正完了、最適な設計に到達、ドキュメント化完了、コミット待ち

## 問題と修正の詳細

### 問題1: プッシュ先のブランチ不一致
- **症状**: バージョン更新時に`error: src refspec main does not match any`
- **原因**: L92のプッシュ先が`main`のままだった
- **修正**: `git push origin main`を`git push origin release`に変更

### 問題2: releaseジョブが実行されない
- **症状**: バージョン更新後、releaseビルドが実行されない
- **原因**: releaseジョブが`needs: version`でversionジョブに依存していたが、両ジョブの実行条件が相互排他的
  - versionジョブ: 「bump versionを含まない」コミットで実行
  - releaseジョブ: 「bump versionを含む」コミットで実行
- **修正**:
  1. `needs: version`を削除
  2. package.jsonから直接バージョンを読み取る新しいステップを追加
  3. `needs.version.outputs.new_tag`を`env.TAG`に変更

### 問題3: releaseジョブがスキップされる
- **症状**: versionジョブは実行されるが、releaseジョブが「This job was skipped」となる
- **原因**: L87のバージョン更新コミットメッセージに`[skip ci]`が含まれており、バージョン更新コミットがプッシュされてもワークフロー全体がスキップされていた
- **修正**: `[skip ci]`を削除

### 最終的な設計（問題4の根本的な解決）
- **当初の問題**: releaseジョブがスキップされ続ける
- **試行錯誤の経緯**:
  1. 最初は`needs: version`がなく、releaseジョブが実行されなかった
  2. `needs: version`と`always()`を追加したが、2回ビルドされる問題が発生
  3. `always() && contains(...)`に変更したが、無駄な依存関係が残る
- **ユーザーからの指摘**: 同時処理のことを考えていない、`needs`は不要
- **根本的な理解**:
  - versionジョブとreleaseジョブは**別々のプッシュイベント**で実行される
  - 通常のコミット → versionジョブのみ実行 → バージョン更新コミットをプッシュ
  - バージョン更新コミット → releaseジョブのみ実行
  - 2つのジョブは完全に独立しており、`needs`で繋ぐ必要はない
- **最終的な設計**:
  - versionジョブ: `if: !contains(..., 'bump version')`
  - releaseジョブ: `if: contains(..., 'bump version')`
  - 依存関係なし、シンプルで効率的
