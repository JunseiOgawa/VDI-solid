# Tauri起動時間最適化タスクリスト

## 準備作業

- [x] 設計ドキュメント作成(`design.md`)
- [x] タスクリスト作成(`task.md`)
- [ ] feature/optimize-tauri-performanceブランチ作成

## Phase 1: Rust側の最適化

### 1.1 Cargo.tomlリリースプロファイル最適化

**目的**: バイナリサイズと起動時間の最適化

- [ ] `opt-level`を`3`から`"s"`に変更
- [ ] `lto`を`"thin"`から`true`に変更
- [ ] 設定を確認してコミット
- [ ] コミットメッセージ: "opt: Cargoリリースプロファイルを最適化"

**期待効果**: バイナリサイズ20-40%削減、起動時間50-100ms短縮

### 1.2 lazy_staticをonce_cellに置き換え

**目的**: より現代的で効率的な遅延初期化

**ステップ**:
- [ ] Cargo.tomlで`lazy_static`を削除、`once_cell`を追加
- [ ] lazy_staticを使用しているファイルを特定
  - `src-tauri/src/peaking.rs`を確認
  - その他の使用箇所を検索
- [ ] コードを`once_cell::sync::Lazy`に置き換え
- [ ] ビルドしてエラーがないことを確認
- [ ] コミットメッセージ: "refactor: lazy_staticをonce_cellに置き換え"

**期待効果**: 初期化オーバーヘッド削減、コード品質向上

### 1.3 依存関係の機能フラグ最適化

**目的**: 不要な機能を除外してバイナリサイズ削減

**tokio最適化**:
- [ ] 現在の機能使用状況を確認
- [ ] 必要最小限の機能に絞る
- [ ] ビルドしてエラーがないことを確認
- [ ] コミットメッセージ: "opt: tokio依存関係の機能フラグを最適化"

**image最適化**:
- [ ] 現在の使用フォーマットを確認
- [ ] 使用頻度の低いフォーマット(bmp, tiff)の削除を検討
- [ ] ビルドしてエラーがないことを確認
- [ ] コミットメッセージ: "opt: imageクレートの機能フラグを最適化"

**期待効果**: バイナリサイズ5-15%削減

## Phase 2: Tauri設定の最適化

### 2.1 withGlobalTauriをfalseに変更

**目的**: 不要なグローバル変数を削除

- [ ] `tauri.conf.json`の`withGlobalTauri`を`false`に変更
- [ ] ビルドして動作確認
- [ ] コミットメッセージ: "opt: withGlobalTauriを無効化"

**期待効果**: 初期化時間10-20ms短縮

### 2.2 removeUnusedCommandsを追加

**目的**: 未使用コマンドをバイナリから削除

- [ ] `tauri.conf.json`の`build`セクションに`removeUnusedCommands: true`を追加
- [ ] ビルドして動作確認
- [ ] コミットメッセージ: "opt: 未使用コマンドの削除を有効化"

**期待効果**: バイナリサイズ削減、IPCオーバーヘッド削減

### 2.3 transparent設定の影響確認

**目的**: レンダリングオーバーヘッドの削減

**注意**: この変更はUIに影響する可能性があるため、慎重に実施

- [ ] `transparent: true`の使用箇所を確認
- [ ] カスタムタイトルバーへの影響を調査
- [ ] テスト環境で`transparent: false`に変更して確認
- [ ] UI崩れがないか確認
- [ ] 問題なければコミット、問題があれば元に戻す
- [ ] コミットメッセージ: "opt: ウィンドウ透明性を無効化" または "test: transparent設定の影響確認"

**期待効果**: 初期化時間10-30ms短縮

### 2.4 CSP最適化(オプション)

**目的**: セキュリティ向上とパース時間の最小化

- [ ] 現在のCSP設定を確認
- [ ] より具体的なCSPポリシーを設定
- [ ] ビルドして動作確認
- [ ] コミットメッセージ: "opt: CSPポリシーを最適化"

## Phase 3: 検証とテスト

### 3.1 ビルドサイズ比較

- [ ] 最適化前のバイナリサイズを記録
  ```bash
  ls -lh src-tauri/target/release/vdi-solid
  ```
- [ ] 最適化後のバイナリサイズを記録
- [ ] 削減率を計算
- [ ] 結果をドキュメントに記録

### 3.2 起動時間計測

- [ ] 最適化前の起動時間を計測(複数回測定して平均)
- [ ] 最適化後の起動時間を計測(複数回測定して平均)
- [ ] 短縮時間と短縮率を計算
- [ ] 結果をドキュメントに記録

### 3.3 機能動作確認

- [ ] アプリケーションが正常に起動すること
- [ ] 画像表示が正常に動作すること
- [ ] ズーム機能が正常に動作すること
- [ ] 回転機能が正常に動作すること
- [ ] ナビゲーション機能が正常に動作すること
- [ ] 設定メニューが正常に動作すること
- [ ] ピーキング機能が正常に動作すること
- [ ] ヒストグラム機能が正常に動作すること
- [ ] フルスクリーン引数起動が正常に動作すること

### 3.4 各プラットフォームでの確認

- [ ] Windows環境での動作確認(可能であれば)
- [ ] macOS環境での動作確認(可能であれば)
- [ ] Linux環境での動作確認

## Phase 4: ドキュメント更新

- [ ] 最適化結果を`docs/20251118_tauri_performance_optimization/results.md`に記録
- [ ] `docs/task.md`を更新(必要に応じて)
- [ ] CHANGELOGへの追記(リリース時)

## 実装順序とコミット戦略

### 優先順位
1. **高**: Cargo.toml最適化、once_cell置き換え
2. **中**: Tauri設定最適化、依存関係最適化
3. **低**: CSP最適化

### コミット単位
- 各最適化項目ごとに個別にコミット
- ビルドが成功することを確認してからコミット
- コミットメッセージは"opt:"または"refactor:"プレフィックスを使用

### 確認ポイント
- 各コミット後にビルド成功を確認
- Phase 1完了後に動作確認
- Phase 2完了後に動作確認
- 最終的に全機能の動作確認

## リスク管理

### 高リスク項目
- transparent設定の変更 → UI崩れの可能性
- 依存関係の機能削減 → 機能不全の可能性

### 対策
- 段階的に実施
- 各変更後に動作確認
- 問題があれば即座にロールバック
- テスト環境で十分に確認

## 成功基準

### 必須要件
- [x] 全タスクが完了していること
- [ ] ビルドが成功すること
- [ ] 全機能が正常に動作すること

### パフォーマンス要件
- [ ] バイナリサイズが20%以上削減されていること
- [ ] 起動時間が改善されていること

### 品質要件
- [ ] 既存機能が全て動作すること
- [ ] UI/UXが劣化していないこと
- [ ] ビルド時間が極端に増加していないこと

## 備考

- 開発用プロファイルは維持し、最適化はリリースビルドのみに適用
- ビルド時間の増加は許容範囲内(数分程度)
- パフォーマンス計測は複数回実行して平均値を取る
